#include "Constructor.h"

using namespace NKHook5::Patches::CBloonsTD5Game;

uintptr_t o_func;
void* __fastcall cb_hook(void* gameInstance) {
    std::cout << "Gameinstance created: " << gameInstance << std::endl;
    return PLH::FnCast(o_func, &cb_hook)(gameInstance);
}

auto Constructor::Apply() -> bool
{
    const uintptr_t address = NKHook5::Utils::findPattern("55 8B EC 6A ?? 68 ?? ?? ?? ?? 64 ?? ?? ?? ?? ?? 50 51 56 A1 34 ?? ?? ?? 33 C5 50 8D ?? ?? ?? A3 ?? ?? ?? ?? 8B F1 ?? 75 ?? E8 ?? ?? ?? ?? ?? 45 ?? ?? ?? ?? ?? ?? 86 ?? ?? ?? ?? ?? ?? ?? ?? ?? 86 ?? ?? ?? ?? ?? ?? ?? ?? ?? 86 ?? ?? ?? ?? ?? ?? ?? ?? ?? 86 ?? ?? ?? ?? ?? ?? ?? ?? ?? 86");
    if(address)
    {
        PLH::x86Detour detour(address, (const uintptr_t)&cb_hook, &o_func, GetDis());
        if(detour.hook())
        {
            return true;
        }
        else
        {
            return false;
        }
    }
    else
    {
        return false;
    }
}